<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VaultBook - Dashboard</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=VT323&display=swap" rel="stylesheet" />

        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            background: "#447AB9",
                            primary: "#FEF265",
                            "primary-foreground": "#0D0D01",
                        },
                        fontFamily: {
                            sans: ['"Roboto Condensed"', "sans-serif"],
                            mono: ['"VT323"', "monospace"],
                        },
                    },
                },
            };
        </script>

        <style>
            ::selection {
                background-color: #fef265;
                color: #000;
            }
            nav{
                background: rgba(13, 13, 1, 0.85);
            }
            .text-glow {
                text-shadow: 0 0 8px rgba(254, 242, 101, 0.6);
            }
            .vault-card {
                background: rgba(13, 13, 1, 0.85);
                border: 2px solid #fef265;
                box-shadow: 0 0 15px rgba(254, 242, 101, 0.1);
                transition: all 0.3s ease;
            }
            .vault-card:hover {
                box-shadow: 0 0 25px rgba(254, 242, 101, 0.3);
                transform: translateY(-5px);
            }
            .crt-overlay {
                background: linear-gradient(rgba(17, 18, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
                background-size: 100% 4px;
                pointer-events: none;
            }
        </style>
    </head>
    <body class="min-h-screen bg-[url('vault-tec-bg.png')] bg-cover bg-center text-primary font-sans relative items-center justify-center">
        
        <div class="fixed inset-0 crt-overlay z-50"></div>
        <div class="absolute inset-0 bg-[#447AB9]/80 mix-blend-multiply z-0"></div>
        <div class="absolute inset-0 bg-black/20 z-0"></div>
        
        <!--navbar-->
        <nav class="sticky bg-black top-0 flex justify-between items-center px-10 py-4 shadow-md z-20">
            <div class="text-2xl font-bold text-blue-600 text-primary mr-5">
                VaultBook
            </div>
    
            <div class="md:mx-10 md:max-w-[30%] text-gray-500 mr-5">
                <div class="flex-1 border-2 border-[#fef265] p-3 items-center gap-5 focus-within:animate-pulse">
                    <span class="font-mono text-xl ml-2">&gt; SEARCH_FILTER:</span>
                    <input type="text"
                           id="vaultSearch"
                           placeholder="ENTER NAME OR VAULT ID..."
                           class="bg-transparent border-b border-primary/20 outline-none flex-1 font-mono text-xl placeholder:opacity-30 focus:border-primary transition-colors">
                </div>
            </div>
    
            <div class="flex space gap-5">
                <button id="logout" class="font-mono px-6 py-1 border border-red-500/50 text-red-500 text-xl transition-all
                            hover:bg-[#fef26599] hover:bg-red-500 hover:text-white uppercase">
                    [ LogOut ]
                </button>
                <button class="w-12 h-12 border-2 border-primary rounded-full flex items-center justify-center">
                </button>
            </div>
        </nav>
      
        <div class="relative z-10 max-w-[55%] mx-auto space-y-8 mt-10">
            <main class="grid grid-cols-1 md:grid-cols-2 gap-12 items-start">
                <!--main dashboard where vaults are located-->

            </main>
        </div>
        <script>
            // if the search bar is empty, show all vaults again
            const searchInput = document.getElementById('vaultSearch');
            const vaultGrid = document.querySelector('main.grid');

            document.addEventListener("DOMContentLoaded", () => {
                // run an empty search if there is no input yet
                doSearch(""); 
            });
            
            searchInput.addEventListener("input", (e) => {
                const searchText = e.target.value;
                doSearch(searchText);
            });

            document.getElementById("logout").onclick = function () {
                location.href = "index1.html";
            };
            
            async function doSearch(term) {
                const parts = term.trim().split(" ");
                const lastPart = parts[parts.length - 1];
                const hasVaultFilter = !isNaN(lastPart) && parts.length > 1;

                const vaultInput = hasVaultFilter ? parseInt(lastPart) : 0;
                const nameInput = hasVaultFilter ? parts.slice(0, -1).join(" ") : term;

                const payload = {
                    search: nameInput,
                    vaultnum: vaultInput
                };

                //console.log("Terminal Sending:", payload); //for debugging

                try {
                    const response = await fetch("Search.php", {
                        method: "POST",
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "application/json" }
                    });

                    const data = await response.json();
                    renderResults(data.results);
                } catch (err) {
                    console.error("Connection failed", err);
                    renderResults([]);
                }
            }

            function renderResults(results) {
                // clear the current static vaults
                vaultGrid.innerHTML = "";

                const isSearching = searchInput.value.trim().length > 0;
                
                //group each contact by their corresponding vaultnumber
                const groups = {};
                results.forEach(c => {
                    if (!groups[c.vaultNumber])
                        groups[c.vaultNumber] = [];
                    groups[c.vaultNumber].push(c);
                });

                if (isSearching) {
                    //only show vaults that HAVE data
                    Object.keys(groups).forEach(vNum => {
                        vaultGrid.innerHTML += renderActives(vNum, groups[vNum]);
                    });
                    
                    //show a "No matches" message if the whole screen is blank
                    if (results.length === 0) {
                        vaultGrid.innerHTML = '<div class="col-span-full text-center font-mono text-4xl py-40 opacity-50">NO MATCHING DWELLERS FOUND IN SYSTEM</div>';
                    }
                } else {
                    //show all 10 vaults if there is no ongoing search
                    for (let i = 1; i <= 10; i++) {
                        if (groups[i]) {
                            vaultGrid.innerHTML += renderActives(i, groups[i]);
                        } else {
                            vaultGrid.innerHTML += renderEmpties(i);
                        }
                    }
                }
            }

            // render the active vaults where any search matches the regex
            function renderActives(vNum, contacts) {
                let contactList = contacts.map(c => `
                    <div class="flex flex-col">
                        <div onclick="toggleDetails(this)" class="flex items-center justify-between p-3 border border-primary/20 hover:bg-primary/5 group cursor-pointer">
                            <span class="font-bold text-lg uppercase">${c.firstName} ${c.lastName}</span>
                            <span class="font-mono opacity-0 group-hover:opacity-100 transition-opacity">&gt; VIEW DATA</span>
                        </div>
                        <div class="details-pane hidden grid grid-cols-1 p-3 bg-black/70 border-t border-primary/10">
                            <span class="font-mono uppercase opacity-80">UserID: ${c.userID}</span>
                            <span class="font-mono uppercase opacity-80">Phone: ${c.phone}</span>
                            <span class="font-mono uppercase opacity-80">Email: ${c.email}</span>
                        </div>    
                    </div>
                `).join("");

                return `
                    <section class="vault-card">
                        <div class="bg-primary text-background p-3 font-bold flex justify-between items-center">
                            <span class="font-mono tracking-widest uppercase ml-5">VAULT ${vNum}</span>
                            <span class="text-xs uppercase px-2 py-0.5 border border-background">Active</span>
                        </div>
                        <div class="p-6 space-y-4">${contactList}</div>
                    </section>`;
            }

            //render the remaining vaults as empty if there is no search
            function renderEmpties(vNum) {
                return `
                    <section class="vault-card overflow-hidden opacity-70">
                        <div class="bg-primary text-background p-3 font-bold flex justify-between items-center">
                            <span class="font-mono tracking-widest uppercase ml-5">VAULT ${vNum}</span>
                            <span class="text-xs uppercase px-2 py-0.5 border border-background">Empty</span>
                        </div>
                        <div class="p-6 text-center italic py-10 font-mono">NO DATA RETRIEVED</div>
                    </section>`;
            }

            //drop-down the details of the contacts (used in renderActives)
            function toggleDetails(element){
                const details = element.nextElementSibling;
                details.classList.toggle('hidden');
                const btn = element.querySelector('span:last-child');

                btn.innerHTML = details.classList.contains('hidden') ? '> VIEW DATA' : '> HIDE DATA';
            }
        </script>
    </body>
</html>